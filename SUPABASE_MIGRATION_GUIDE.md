# Supabase Database Migration Guide

## Step-by-Step Process to Replicate Database

### Step 1: Create a New Supabase Project

1. Go to [https://supabase.com](https://supabase.com)
2. Sign up or log in to your account
3. Click "New Project"
4. Fill in:
   - Project name: `pharmacare` (or your preferred name)
   - Database password: Choose a strong password (save it securely)
   - Region: Choose closest to your users
5. Wait for the project to be created (~2 minutes)

### Step 2: Access SQL Editor

1. In your Supabase dashboard, navigate to **SQL Editor** (left sidebar)
2. Click **New Query**

### Step 3: Run the Complete Schema Migration

Copy and paste the SQL from `SUPABASE_SCHEMA.sql` (provided below) into the SQL editor and click **Run**.

This will create:
- All enums (app_role)
- All tables (users, profiles, user_roles, medicine_categories, medicines, sales)
- All functions (handle_new_user, has_role, handle_updated_at)
- All triggers
- All indexes
- All RLS policies

### Step 4: Configure Authentication

1. Go to **Authentication** → **Settings** in your Supabase dashboard
2. Under **Auth Providers**, enable **Email** provider
3. Disable email confirmations for testing:
   - Scroll to **Email Auth**
   - Toggle **OFF** "Enable email confirmations"
   - Click **Save**

### Step 5: Create Initial Admin User

1. Go to **Authentication** → **Users**
2. Click **Add User** → **Create new user**
3. Enter:
   - Email: `admin@pharmacare.com`
   - Password: Choose a strong password
   - Auto Confirm User: **Yes**
4. Click **Create User**
5. Copy the User ID (UUID)

### Step 6: Assign Admin Role

1. Go back to **SQL Editor**
2. Run this query (replace `YOUR_USER_ID` with the copied UUID):

```sql
INSERT INTO public.user_roles (user_id, role)
VALUES ('YOUR_USER_ID', 'admin');
```

### Step 7: Import Existing Data

1. Go back to **SQL Editor**
2. Click **New Query**
3. Copy and paste the entire content from `SUPABASE_DATA_EXPORT.sql`
4. Click **Run**
5. You should see a success message with counts of imported data

**What gets imported:**
- 8 Medicine Categories
- 5 Existing Medicines with stock levels
- Sales history (optional - see note in SQL file)

**Note on Sales Data:**
- Sales records contain references to user IDs (sold_by field)
- These will only import correctly if you manually create matching users
- For a fresh start, you can skip sales import and create new sales going forward

### Step 8: Get Your Supabase Credentials

1. Go to **Project Settings** → **API**
2. Copy these values:
   - **Project URL** (e.g., `https://xxxxx.supabase.co`)
   - **anon/public key** (starts with `eyJ...`)
   - **service_role key** (keep this secret!)

### Step 9: Update Your Frontend

Replace the values in your `.env` file:

```env
VITE_SUPABASE_URL=https://your-project-id.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=your-anon-key-here
```

### Step 10: Test the Connection

1. Restart your development server
2. Try logging in with the admin user you created
3. Test creating medicines, categories, and sales

## Troubleshooting

### Issue: "new row violates row-level security policy"

**Solution**: Make sure you're logged in with a user that has the appropriate role assigned in the `user_roles` table.

### Issue: "relation does not exist"

**Solution**: Re-run the schema SQL. Make sure all tables were created successfully.

### Issue: Can't see data after login

**Solution**: Check RLS policies are enabled and your user has the correct role in `user_roles` table.

### Issue: Auth trigger not working

**Solution**: Make sure the `handle_new_user()` function and `on_auth_user_created` trigger were created successfully.

## Security Notes

⚠️ **Important Security Settings for Production:**

1. **Enable email confirmations** (disabled for development ease)
2. **Use strong JWT secrets** (auto-generated by Supabase)
3. **Never expose service_role key** in frontend code
4. **Set up proper CORS** in Supabase settings
5. **Enable 2FA** for admin users
6. **Regular backups** of your database

## Next Steps

After successful migration:
- Create additional users via the signup flow
- Assign roles as needed
- Import existing data if migrating from another system
- Set up production environment variables
- Configure custom domain (if needed)
